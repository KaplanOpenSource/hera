#! /usr/bin/env python
import argparse
import logging
from hera.utils.data import CLI

if __name__=="__main__":
    logger = logging.getLogger("hera.bin.hera_projects")

    parser = argparse.ArgumentParser()
    subparsers = parser.add_subparsers(help='sub-command help')

    # ------------------- database management
    db_project = subparsers.add_parser('db', help='Database management')
    db_subparsers = db_project.add_subparsers(help='Database management')

    # List
    db_list = db_subparsers.add_parser('list', help='list project')
    db_list.add_argument('--onlyName', dest="fulldetails", default=True, action="store_false",
                             help='Print only the database connection names')
    db_list.set_defaults(func=CLI.db_list)

    # Create
    db_new = db_subparsers.add_parser('create', help='create a project')
    db_new.add_argument('connectionName', type=str,  help='The database name to create')
    db_new.add_argument('--username', type=str,  required=True,help='The username')
    db_new.add_argument('--password', type=str,  required=True,help='The database name to create')
    db_new.add_argument('--IP', type=str,  required=True,help='The database name to create')
    db_new.add_argument('--databaseName', type=str, required=True, help='The database name to create')
    db_new.set_defaults(func=CLI.db_create)

    # Remove
    db_remove = db_subparsers.add_parser('remove', help='create a project')
    db_remove.add_argument('connectionName', type=str, default=None, help='The database name to create')
    db_remove.set_defaults(func=CLI.db_remove)

    # ------------------- project management
    parser_project = subparsers.add_parser('project', help='projects management')
    project_subparsers = parser_project.add_subparsers(help='projects management')

    # List
    parser_list = project_subparsers.add_parser('list', help='list project')
    parser_list.add_argument('--connectionName', dest="connectionName", type=str, default=None,
                            help='connection to use. The default is the user name')
    parser_list.add_argument('--onlyName', dest="fulldetails", default=True, action="store_false",help='Print only the project name')
    parser_list.set_defaults(func=CLI.project_list)

    # Create
    parser_new = project_subparsers.add_parser('create', help='create a project')
    parser_new.add_argument('projectName', type=str, default=None, help='The project name to create')
    parser_new.add_argument('--directory', dest="directory",type=str, default=None, help='directory to create the project in')
    parser_new.set_defaults(func=CLI.project_create)

    ### Dump/save
    parser_dump = project_subparsers.add_parser('dump', help='Saves the project record to the disk')
    parser_dump.add_argument('projectName', type=str, default=None, help='The project name to create')
    parser_dump.add_argument('query',metavar='query',nargs='*', type=str, help='the query parameters')
    parser_dump.add_argument('--fileName',type=str, help='save to',default=None,required=False)
    parser_dump.add_argument('--format', dest="outputFormat", default="table",choices=['table','json'], help='Print only the project name')
    parser_dump.set_defaults(func=CLI.project_dump)

    ### Load
    parser_load = project_subparsers.add_parser('load', help='load records from a file')
    parser_load.add_argument('projectName', type=str, default=None, help='The project name to create')
    parser_load.add_argument('projectName', type=str, help='The workflow file to load')
    parser_load.set_defaults(func=CLI.project_load)

    # ----------------- Repository
    repository_parser = subparsers.add_parser('repository', help='handling repositories')
    repository_subparsers = repository_parser.add_subparsers(help='sub-command help')

    # list
    repository_list = repository_subparsers.add_parser('list', help='lists objects')
    repository_list.set_defaults(func=CLI.repository_list)

    ### add
    repository_load = repository_subparsers.add_parser('add', help='Add the data repository to the database')
    repository_load.add_argument('repositoryName', type=str, help='The name of the repository')
    repository_load.add_argument('repositoryPath', type=str, help='The name of the repository')
    repository_load.set_defaults(func=CLI.repository_add)

    ##################### exec
    parsed = parser.parse_args()
    logger.debug(f"Got {parsed} in the command line")
    if 'func' not in parsed:
        parser.print_help()
    else:
        parsed.func(parsed)









